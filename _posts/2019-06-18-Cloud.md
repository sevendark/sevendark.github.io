---
title: "NextCloud ç½‘ç›˜æ­å»º"
categories:
  - Tec
tags:
  - ç½‘ç›˜
toc: true
header:
  teaser: /assets/blog_images/Nextcloud.png
---
çè—è®¸ä¹…çš„ä¸œè¥¿æ€»æ˜¯æ— å¤„å®‰æ”¾ï¼Œç»ˆæœ‰ä¸€æ—¥å‘ç°äº†NextCloudè¿™ä¸ªå¥½ä¸œè¥¿ï¼Œäºæ˜¯ç«‹é©¬å¼€å¹²ã€‚è¿™ä¸ªå¼€æºçš„ç½‘ç›˜æœ‰è‹¹æœå®‰å“Appï¼Œè¿˜æœ‰MACï¼ŒWindowsæ¡Œé¢è½¯ä»¶ï¼Œç®€ç›´å¤ªå…¨ä¹äº†å¥½å˜›ã€‚ä¸ºäº†æ­å»ºç½‘ç›˜ï¼Œæˆ‘åœ¨è…¾è®¯äº‘ä¸Šè´­ä¹°äº†2æ ¸8Gå†…å­˜100GBçš„æœåŠ¡å™¨ï¼Œé«˜é…æ˜¯æµç•…ä½“éªŒçš„å‰æï¼Œä¹ˆçš„åŠæ³•ï¼Œè™½ç„¶è´µï¼Œä½†æ˜¯ä¸ºäº†çˆ½ï¼Œå¿äº†ã€‚åç»­æ›´æ–°ï¼šç»ˆç©¶è¿˜æ˜¯å¤ªè´µäº†ï¼Œç”¨å›äº†ä¸€ä¸ªæœˆ47çš„1G+50GæœåŠ¡å™¨ï¼ŒğŸ¤£

# snap å®‰è£…ï¼ˆç›®å‰snapåªæœ‰æ—§ç‰ˆ(16.0.0),ä¸æ”¯æŒæœ€æ–°çš„18.0.0ï¼‰

æœåŠ¡å™¨é…ç½®ï¼š

```
äº‘æœåŠ¡å•† ï¼š è…¾è®¯äº‘
ç³»ç»Ÿï¼š  Ubuntu 18.04.1 LTS
è¿å­˜ï¼š  1G
å†…å­˜ï¼š  50G
```

## æ‰§è¡Œsnapå®‰è£…å‘½ä»¤
```sh
$ sudo snap install nextcloud
```

## å¯åŠ¨æœåŠ¡
```sh
$ sudo snap start nextcloud
```

## å¼€å¯httpsæ¨¡å¼
```sh
$ sudo nextcloud.enable-https lets-encrypt
```

## è®¾ç½®å¯åŠ¨ç«¯å£
```sh
$ sudo snap set nextcloud ports.http=80
```

å®˜æ–¹snapä»“åº“åœ°å€ï¼š[https://github.com/nextcloud/nextcloud-snap](https://github.com/nextcloud/nextcloud-snap){:target="_blank"}

# æ‰‹åŠ¨å®‰è£…ï¼ˆæ”¯æŒæœ€æ–°çš„ç‰ˆæœ¬ï¼Œä½†æ˜¯æ¯”è¾ƒç¹çï¼‰

## å®‰è£…mysql

```sh
$ sudo apt-get install mysql-server-5.7
```

## é…ç½®ç¼–ç 

```
[mysqld]
character-set-server = utf8mb4
collation-server = utf8mb4_general_ci
transaction_isolation = READ-COMMITTED
binlog_format = ROW
innodb_large_prefix=on
innodb_file_format=barracuda
innodb_file_per_table=1
```

## é…ç½®rootå¯†ç ï¼Œå¹¶å…è®¸ésudoç™»é™†
æ³¨æ„åœ¨è¿™é‡Œç™»å½•æ—¶å¯ä»¥ç›´æ¥å›è½¦è¿›å…¥ï¼Œåˆå§‹å®‰è£…æ²¡æœ‰å¯†ç 
```sh
$ sudo mysql -u root -p
myqsl > ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'your-password';
```

## åˆ›å»ºç”¨æˆ·ï¼Œä»“åº“
å¦‚æœéœ€è¦è¿œç¨‹ç™»é™†ï¼Œæ›¿æ¢`localhost`ä¸º`%`
```sh
mysql > create database nextcloud;
mysql > CREATE USER 'nextcloud'@'localhost' IDENTIFIED BY '000000';
mysql > GRANT ALL PRIVILEGES ON nextcloud.* TO 'nextcloud'@'localhost';
mysql > flush privileges;
```

## å®‰è£…phpï¼ŒåŠå…¶æ¨¡å—

```sh
$ sudo apt-get install php
$ sudo apt-get install php-dompdf unzip
$ sudo apt-get install php-gd php-json php-mysql php-curl php-mbstring
$ sudo apt-get install php-intl php-imagick php-xml php-zip
$ sudo apt-get install libapache2-mod-php
```


## é…ç½®php.ini
apache2 æœåŠ¡å™¨ä½¿ç”¨çš„php.ini: `/etc/php/7.2/apache2/php.ini`
cloud cron jobsä½¿ç”¨çš„php.ini: `/etc/php/7.2/cli/php.ini`

åœ¨apache2çš„php.iniä¸­è®¾ç½®æœ€å¤§æ–‡ä»¶ä¸Šä¼ å¤§å°ä»¥åŠphpå†…å­˜é™åˆ¶
```
memory_limit = 512M
upload_max_filesize = 50M
```


## å®‰è£…reids
```sh
$ sudo apt-get install php-redis redis-server
$ sudo apt-get install php-apcu 
```


## å®‰è£…apache2
```sh
$ sudo apt-get install apache2
```

## å¼€å¯sslï¼Œå¹¶è®¾ç½®è¯ä¹¦
```sh
$ sudo wget https://dl.eff.org/certbot-auto && sudo chmod a+x certbot-auto
$ sudo ./certbot-auto --apache --agree-tos --rsa-key-size 4096 --email your@email.com --redirect -d your.domain.com
```

## é…ç½®apache2

```sh
$ sudo a2enmod headers
```

ç¼–è¾‘`/etc/apache2/sites-available/000-default-le-ssl.conf`æ–‡ä»¶ï¼š
1. åœ¨`ServerName`ä¸‹é¢è¿½åŠ 

```
<IfModule mod_headers.c>
    Header always set Strict-Transport-Security "max-age=15768000; preload"
</IfModule>
```

2. æ›´æ”¹`/var/www/html`ä¸º`/var/www/nextcloud`ï¼Œå¦‚æœä½ ä¸æƒ³nextcloudç›´æ¥ä½œä¸ºæ ¹ç›®å½•ï¼Œéœ€è¦åœ¨è®¿é—®æ—¶ä½¿ç”¨ï¼š`https://host/nextcloud`

ç¼–è¾‘`/etc/apache2/apache2.conf`æ–‡ä»¶, å°†æ‰€æœ‰çš„`AllowOverride None`æ›´æ”¹ä¸º`AllowOverride All`

## ä¸‹è½½nextcloudå‹ç¼©åŒ…

[https://nextcloud.com/install/](https://nextcloud.com/install/){:target="_blank"}

è§£å‹å†…å®¹è‡³`/var/www/`, è§£å‹å®Œæˆæœ€ç»ˆç›®å½•ä¸º`/var/www/nextcloud/...`

## é…ç½®redis

åœ¨`/var/www/nextcloud/conf.d/config.php`ä¸­è¿½åŠ å†…å®¹

```
  'memcache.local' => '\OC\Memcache\APCu',
  'memcache.locking' => '\OC\Memcache\Redis',
  'memcache.distributed' => '\OC\Memcache\Redis',
  'redis' => [
      'host' => 'localhost',
      'port' => 6379,
  ],
```

## æ‰“å¼€ç½‘ç«™ï¼Œé…ç½®mysqlï¼Œåˆ›å»ºadminç­‰


# é™„å½•


å®˜æ–¹ç½‘ç«™åœ°å€ï¼š[https://nextcloud.com/](https://nextcloud.com/){:target="_blank"}